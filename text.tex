\documentclass{article}

\usepackage
    { luacode
    % , fancyvrb
    , fvextra
    , ifthen
    , fontspec
    , xcolor
    , tikz
    }

\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
             \node[shape=circle,fill=black,draw,inner sep=1pt] (char) {\textcolor{white}{\texttt{#1}}};}}


\definecolor{unimportant}{gray}{0.5}

\newcommand\codeHighlight[1]{\textbf{#1}}
\newcommand\codeUnimportant[1]{\textcolor{unimportant}{#1}}

% \newfontfamily{\cyrillicfonttt}{Hack}
\setmonofont{Hack}[Scale=MatchLowercase]


\directlua{dofile("diverb.lua")}

\newenvironment{diverb}{%
    \directlua{start_recording()}}{%
    \directlua{stop_recording()}
}

\begin{document}

This

\begin{diverb}
//  |
//~
        Hello {World}
//!
        This is me speaking, you know. // <1>
        This is {} me speaking, you know. // <2>
//           ^^^^^^^^           ^^^^^^^^
        This is me speaking, you know.

        Before ::: after
//~
        Hello {World}
\end{diverb}

Lorem ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet.
Lorem ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet.
Lorem \circled{1} ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet.
Lorem ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet.
Lorem ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet.
Lorem ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet.
Lorem ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet ipsum dolor sit amet.


\end{document}
